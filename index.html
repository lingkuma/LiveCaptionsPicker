<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveCaptionsPicker - LunaTranslator</title>
    <link rel="icon" type="image/png" href="icon16.png">
    <link rel="shortcut icon" type="image/png" href="icon16.png">
    <style>
        :root {
            /* é»‘æš—æ¨¡å¼å˜é‡ (é»˜è®¤) */
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --header-color: #ffffff;
        }

        [data-theme="light"] {
            /* æµ…è‰²æ¨¡å¼å˜é‡ */
            --bg-color: #f7f9fa;
            --container-bg: #ffffff;
            --text-color: #222;
            --text-secondary: #666;
            --border-color: #e6e6e6;
            --header-color: #333;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', 'Microsoft YaHei', serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 18px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: var(--container-bg);
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .header h1 {
            margin: 0;
            color: var(--header-color);
            font-size: 2.2em;
            font-weight: 400;
            letter-spacing: -0.02em;
            transition: color 0.3s ease;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status.connected {
            background-color: #4caf50;
            color: white;
        }

        .status.disconnected {
            background-color: #f44336;
            color: white;
        }

        .captions-container {
            min-height: 60vh;
            padding: 0;
            background-color: transparent;
            line-height: 1.7;
        }

        /* åªå¯¹å®æ—¶æ›´æ–°çš„å†…å®¹ç¦æ­¢ç¿»è¯‘ */
        .sentence.incomplete,
        .sentence.incomplete .sentence-text,
        .sentence.incomplete .word {
            /* æ˜ç¡®å‘Šè¯‰æ²‰æµ¸ç¿»è¯‘ä¸è¦ç¿»è¯‘æ­£åœ¨æ›´æ–°çš„å…ƒç´  */
            translate: no;
        }

        /* ä¸ºå®æ—¶æ›´æ–°å†…å®¹æ·»åŠ ç‰¹å®šçš„æ’é™¤æ ‡è®° */
        .sentence.incomplete * {
            /* é˜²æ­¢æ²‰æµ¸ç¿»è¯‘å¤„ç†æ­£åœ¨æ›´æ–°çš„å†…å®¹ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* å®Œæˆçš„å¥å­å…è®¸ç¿»è¯‘å’Œé€‰æ‹© */
        .sentence.completed * {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }



        /* åº•éƒ¨å›ºå®šé«˜åº¦çš„ç©ºç™½åŒºåŸŸï¼Œç”¨äºæä¾›æ»šåŠ¨ç©ºé—´ */
        .bottom-spacer {
            height: 300px; /* å›ºå®šé«˜åº¦ï¼Œæä¾›æ»šåŠ¨ç©ºé—´ */
            background-color: transparent;
        }

        .sentence {
            margin-bottom: 24px;
            padding: 0;
            border: none;
            background: transparent;
        }

        .sentence.completed {
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .sentence.incomplete {
            color: var(--text-secondary);
            position: relative;
            transition: color 0.3s ease;
        }

        .sentence.incomplete::after {
            content: '';
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: var(--text-color);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: text-bottom;
            transition: background-color 0.3s ease;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .sentence-text {
            font-size: 1em;
            word-wrap: break-word;
            letter-spacing: 0.01em;
            margin: 0;
        }

        /* å•è¯çº§åˆ«æ ·å¼ */
        .word {
            display: inline;
            color: var(--text-color);
            opacity: 1;
            background-color: transparent;
            padding: 0;
            margin: 0;
        }

        .word.stable {
            color: var(--text-color);
            opacity: 1;
        }

        .word.updating {
            color: var(--text-color);
            opacity: 1;
            background-color: transparent;
        }

        /* å®Œæˆå¥å­ä¸­çš„å•è¯éƒ½æ˜¯ç¨³å®šçš„ */
        .sentence.completed .word {
            color: var(--text-color);
            opacity: 1;
            background-color: transparent;
        }

        .controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .btn {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,122,204,0.3);
            min-width: 120px;
            text-align: center;
        }

        .btn:hover {
            background-color: #005a9e;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,122,204,0.4);
        }

        .btn.clear {
            background-color: #dc3545;
            box-shadow: 0 2px 8px rgba(220,53,69,0.3);
        }

        .btn.clear:hover {
            background-color: #c82333;
            box-shadow: 0 4px 12px rgba(220,53,69,0.4);
        }

        .btn.telegraph {
            background-color: #28a745;
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }

        .btn.telegraph:hover {
            background-color: #218838;
            box-shadow: 0 4px 12px rgba(40,167,69,0.4);
        }

        .btn.telegraph:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(108,117,125,0.3);
        }

        .btn.telegraph-with-translation {
            background-color: #17a2b8;
            box-shadow: 0 2px 8px rgba(23,162,184,0.3);
        }

        .btn.telegraph-with-translation:hover {
            background-color: #138496;
            box-shadow: 0 4px 12px rgba(23,162,184,0.4);
        }

        .btn.telegraph-with-translation:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(108,117,125,0.3);
        }

        .btn.scroll {
            background-color: #6f42c1;
            box-shadow: 0 2px 8px rgba(111,66,193,0.3);
        }

        .btn.scroll:hover {
            background-color: #5a32a3;
            box-shadow: 0 4px 12px rgba(111,66,193,0.4);
        }

        .btn.auto-scroll {
            background-color: #fd7e14;
            box-shadow: 0 2px 8px rgba(253,126,20,0.3);
        }

        .btn.auto-scroll:hover {
            background-color: #e8650e;
            box-shadow: 0 4px 12px rgba(253,126,20,0.4);
        }

        .btn.auto-scroll.active {
            background-color: #198754;
            box-shadow: 0 2px 8px rgba(25,135,84,0.3);
        }

        .btn.auto-scroll.active:hover {
            background-color: #157347;
            box-shadow: 0 4px 12px rgba(25,135,84,0.4);
        }

        .btn.comma-mode {
            background-color: #6f42c1;
            box-shadow: 0 2px 8px rgba(111,66,193,0.3);
        }

        .btn.comma-mode:hover {
            background-color: #5a32a3;
            box-shadow: 0 4px 12px rgba(111,66,193,0.4);
        }

        .btn.comma-mode.active {
            background-color: #198754;
            box-shadow: 0 2px 8px rgba(25,135,84,0.3);
        }

        .btn.comma-mode.active:hover {
            background-color: #157347;
            box-shadow: 0 4px 12px rgba(25,135,84,0.4);
        }

        .stats {
            position: fixed;
            bottom: 30px;
            left: 30px;
            color: var(--text-secondary);
            font-size: 12px;
            z-index: 1000;
            transition: color 0.3s ease;
        }

        /* å·¦ä¸Šè§’æŒ‰é’®å®¹å™¨ - ç«–ç›´æ’åˆ— */
        .top-left-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .theme-toggle,
        .hide-controls-toggle,
        .lingkuma-install,
        .copy-luna-script,
        .download-luna,
        .tutorial-link,
        .github-link {
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 120px;
        }

        .theme-toggle:hover,
        .hide-controls-toggle:hover,
        .lingkuma-install:hover,
        .copy-luna-script:hover,
        .download-luna:hover,
        .tutorial-link:hover,
        .github-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lingkuma-install {
            background-color: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .lingkuma-install:hover {
            background-color: #45a049;
            border-color: #45a049;
        }

        .copy-luna-script {
            background-color: #007acc;
            color: white;
            border-color: #007acc;
        }

        .copy-luna-script:hover {
            background-color: #005a9e;
            border-color: #005a9e;
        }

        .download-luna {
            background-color: #ff6b35;
            color: white;
            border-color: #ff6b35;
        }

        .download-luna:hover {
            background-color: #e55a2b;
            border-color: #e55a2b;
        }

        .tutorial-link {
            background-color: #9c27b0;
            color: white;
            border-color: #9c27b0;
        }

        .tutorial-link:hover {
            background-color: #7b1fa2;
            border-color: #7b1fa2;
        }

        .github-link {
            background-color: #24292e;
            color: white;
            border-color: #24292e;
        }

        .github-link:hover {
            background-color: #1b1f23;
            border-color: #1b1f23;
        }

        .editable-title {
            background: transparent;
            border: none;
            color: var(--header-color);
            font-size: 2.2em;
            font-weight: 400;
            letter-spacing: -0.02em;
            text-align: center;
            width: 100%;
            transition: color 0.3s ease;
            outline: none;
            font-family: inherit;
        }

        .editable-title:focus {
            background-color: var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
        }

        .controls-hidden .controls,
        .controls-hidden .stats,
        .controls-hidden .status,
        .controls-hidden .theme-toggle,
        .controls-hidden .hide-controls-toggle,
        .controls-hidden .copy-luna-script,
        .controls-hidden .download-luna,
        .controls-hidden .tutorial-link,
        .controls-hidden .lingkuma-install,
        .controls-hidden .github-link {
            opacity: 0;
            pointer-events: none;
        }

        /* éšè—æ§ä»¶æ—¶ï¼Œåœ¨éšè—æŒ‰é’®åŒºåŸŸæ‚¬æµ®æ˜¾ç¤ºæŒ‰é’® */
        .controls-hidden .hide-controls-toggle {
            transition: opacity 0.3s ease;
        }

        /* ä¸ºéšè—æŒ‰é’®æ·»åŠ æ‚¬æµ®åŒºåŸŸ - é€‚åº”ç«–ç›´å¸ƒå±€ */
        .hide-controls-hover-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 400px;
            z-index: 999;
            pointer-events: none;
        }

        .controls-hidden .hide-controls-hover-area {
            pointer-events: auto;
        }

        /* æ‚¬æµ®æ—¶æ˜¾ç¤ºæ‰€æœ‰æŒ‰é’® - ä½¿ç”¨çˆ¶å…ƒç´ hover */
        .controls-hidden .top-left-controls:hover .theme-toggle,
        .controls-hidden .top-left-controls:hover .hide-controls-toggle,
        .controls-hidden .top-left-controls:hover .copy-luna-script,
        .controls-hidden .top-left-controls:hover .download-luna,
        .controls-hidden .top-left-controls:hover .tutorial-link,
        .controls-hidden .top-left-controls:hover .lingkuma-install,
        .controls-hidden .top-left-controls:hover .github-link {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* é€—å·åˆ†å‰²å¥å­æ ·å¼ */
        .comma-split-container {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .comma-split-sentence {
            margin-bottom: 8px;
            padding: 4px 8px;
            background-color: var(--bg-color);
            border-radius: 4px;
            font-size: 0.95em;
            line-height: 1.5;
            transition: all 0.3s ease;
            border-left: 3px solid var(--border-color);
        }

        .comma-split-sentence:last-child {
            margin-bottom: 0;
        }

        .comma-split-sentence.updating {
            border-left-color: #007acc;
            background-color: rgba(0, 122, 204, 0.05);
        }

        .comma-split-sentence.stable {
            border-left-color: var(--text-secondary);
        }

        /* é€—å·åˆ†å‰²å¥å­ä¸­çš„æ–‡æœ¬ä¹Ÿéœ€è¦é˜²ç¿»è¯‘ä¿æŠ¤ */
        .comma-split-sentence.updating,
        .comma-split-sentence.updating * {
            translate: no;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .comma-split-sentence.stable * {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .controls {
                bottom: 20px;
                right: 20px;
            }

            .stats {
                bottom: 20px;
                left: 20px;
                font-size: 11px;
            }

            .top-left-controls {
                top: 15px;
                left: 15px;
                gap: 8px;
            }

            .theme-toggle,
            .hide-controls-toggle,
            .lingkuma-install,
            .copy-luna-script,
            .download-luna,
            .tutorial-link,
            .github-link {
                padding: 6px 10px;
                font-size: 13px;
                min-width: 100px;
            }

            .hide-controls-hover-area {
                left: 0;
                width: 220px;
                height: 320px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- å·¦ä¸Šè§’æŒ‰é’®å®¹å™¨ - ç«–ç›´æ’åˆ— -->
    <div class="top-left-controls">
  

        <a href="https://www.lingkuma.org/live-captions-zh"
           target="_blank"
           class="tutorial-link">
            ğŸ“– ä½¿ç”¨æ•™ç¨‹
        </a>

        <div id="copy-luna-script" class="copy-luna-script" onclick="copyLunaScript()">
            ğŸ“‹ å¤åˆ¶Lunaè„šæœ¬
        </div>

        <a href="https://docs.lunatranslator.org/"
           target="_blank"
           class="download-luna">
            ğŸŒ™ LunaTranslator
        </a>
        <a href="https://chromewebstore.google.com/detail/lingkuma-language-learnin/denpakphibjnpnnkcnhiniicbffdamfh"
        target="_blank"
        class="lingkuma-install">
         ğŸ» Lingkuma
     </a>

     <a href="https://github.com/lingkuma/LiveCaptionsPicker"
     target="_blank"
     class="github-link">
      ğŸ™ GitHub
  </a>
        <div id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">
            ğŸŒ™ æµ…è‰²æ¨¡å¼
        </div>

        <div id="hide-controls-toggle" class="hide-controls-toggle" onclick="toggleControls()">
            ğŸ‘ï¸ éšè—æ§ä»¶
        </div>

        
    </div>

    <!-- éšè—çŠ¶æ€ä¸‹çš„æ‚¬æµ®è§¦å‘åŒºåŸŸ -->
    <div id="hide-controls-hover-area" class="hide-controls-hover-area"></div>

    <div id="status" class="status disconnected">
        æœªè¿æ¥
    </div>

    <div class="container">
        <div class="header">
            <input type="text" class="editable-title" value="Title edit" placeholder="ç‚¹å‡»ç¼–è¾‘æ ‡é¢˜">
        </div>

        <div id="captions-container" class="captions-container">
            <div id="content-wrapper" class="content-wrapper">
                <div class="sentence completed">
                    <div class="sentence-text">Waiting for captions...</div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å›ºå®šç©ºç™½åŒºåŸŸï¼Œæä¾›æ»šåŠ¨ç©ºé—´ -->
        <div class="bottom-spacer"></div>
    </div>

    <div class="controls">
        <button class="btn" onclick="toggleConnection()">
            <span id="connect-btn-text">å¼€å§‹è¿æ¥</span>
        </button>
        <button class="btn clear" onclick="clearCaptions()">æ¸…ç©ºå­—å¹•</button>
        <button class="btn scroll" onclick="scrollToTop()">æ»šåŠ¨åˆ°é¡¶éƒ¨</button>
        <button class="btn scroll" onclick="scrollToBottom()">æ»šåŠ¨åˆ°åº•éƒ¨</button>
        <button id="auto-scroll-btn" class="btn auto-scroll active" onclick="toggleAutoScroll()">
            <span id="auto-scroll-text">ğŸ”„ è‡ªåŠ¨æ»šåŠ¨</span>
        </button>
        <button id="comma-mode-btn" class="btn comma-mode" onclick="toggleCommaMode()">
            <span id="comma-mode-text">ğŸ“ é€—å·æ¢è¡Œ</span>
        </button>
        <button id="telegraph-btn" class="btn telegraph" onclick="sendToTelegraph()">åˆ†äº«åŸæ–‡</button>
        <button id="telegraph-with-translation-btn" class="btn telegraph-with-translation" onclick="sendToTelegraphWithTranslation()">åˆ†äº«é™„æ²‰æµ¸ç¿»è¯‘</button>
    </div>

    <div class="stats">
        <div>ç›‘å¬æ—¶é—´: <span id="listening-time">00:00:00</span></div>
        <div>å•è¯æ€»æ•°: <span id="total-words">0</span></div>
        <div>å®Œæˆå¥å­: <span id="completed-count">0</span></div>
        <div>æœ€åæ›´æ–°: <span id="last-update">ä»æœª</span></div>
    </div>

    <script>
        let isConnected = false;
        let pollInterval = null;
        let completedSentences = [];
        let currentIncomplete = '';
        let lastTimestamp = 0;
        let lastLine = '';  // è®°å½•ä¸Šæ¬¡çš„lineå†…å®¹
        let lastCompletedCount = 0;  // è®°å½•ä¸Šæ¬¡å®Œæˆå¥å­çš„æ•°é‡
        let autoScrollEnabled = true;  // è‡ªåŠ¨æ»šåŠ¨å¼€å…³
        let wordStabilizeTimer = null;  // å•è¯ç¨³å®šåŒ–å®šæ—¶å™¨
        let lastStableContent = '';  // è®°å½•ä¸Šæ¬¡ç¨³å®šçš„å†…å®¹
        let contentChangeCount = 0;  // å†…å®¹å˜åŒ–è®¡æ•°
        let scrollTimer = null;  // æ»šåŠ¨å®šæ—¶å™¨
        let startTime = null;  // å¼€å§‹ç›‘å¬çš„æ—¶é—´
        let totalWords = 0;  // æ€»å•è¯æ•°
        let timeUpdateInterval = null;  // æ—¶é—´æ›´æ–°å®šæ—¶å™¨
        let commaMode = false;  // é€—å·æ¢è¡Œæ¨¡å¼å¼€å…³
        let commaSplitSentences = [];  // é€—å·åˆ†å‰²çš„å¥å­æ•°ç»„

        const statusEl = document.getElementById('status');
        const captionsContainer = document.getElementById('captions-container');
        const contentWrapper = document.getElementById('content-wrapper');
        const connectBtnText = document.getElementById('connect-btn-text');
        const completedCountEl = document.getElementById('completed-count');
        const lastUpdateEl = document.getElementById('last-update');
        const listeningTimeEl = document.getElementById('listening-time');
        const totalWordsEl = document.getElementById('total-words');
        const themeToggleEl = document.getElementById('theme-toggle');
        const hideControlsToggleEl = document.getElementById('hide-controls-toggle');
        const hideControlsHoverAreaEl = document.getElementById('hide-controls-hover-area');
        const autoScrollBtnEl = document.getElementById('auto-scroll-btn');
        const autoScrollTextEl = document.getElementById('auto-scroll-text');
        const commaModeBtnEl = document.getElementById('comma-mode-btn');
        const commaModeTextEl = document.getElementById('comma-mode-text');
        let controlsHidden = false;

        function updateStatus(connected) {
            isConnected = connected;
            if (connected) {
                statusEl.className = 'status connected';
                statusEl.textContent = 'å·²è¿æ¥';
                connectBtnText.textContent = 'æ–­å¼€è¿æ¥';
            } else {
                statusEl.className = 'status disconnected';
                statusEl.textContent = 'æœªè¿æ¥';
                connectBtnText.textContent = 'å¼€å§‹è¿æ¥';
            }
        }

        function toggleConnection() {
            if (isConnected) {
                stopPolling();
            } else {
                startPolling();
            }
        }

        function startPolling() {
            if (pollInterval) return;

            updateStatus(true);

            // è®°å½•å¼€å§‹æ—¶é—´
            if (!startTime) {
                startTime = new Date();
                startTimeUpdateInterval();
            }

            pollInterval = setInterval(fetchCaptions, 300); // æ¯300msè·å–ä¸€æ¬¡æ•°æ®ï¼Œæ›´å¿«å“åº”
            fetchCaptions(); // ç«‹å³è·å–ä¸€æ¬¡
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }

            // åœæ­¢æ—¶é—´æ›´æ–°
            stopTimeUpdateInterval();

            updateStatus(false);
        }

        async function fetchCaptions() {
            try {
                const response = await fetch('http://localhost:8765/captions');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                updateCaptions(data);

            } catch (error) {
                console.error('è·å–å­—å¹•å¤±è´¥:', error);
                updateStatus(false);
                setTimeout(() => {
                    if (isConnected) {
                        startPolling();
                    }
                }, 2000);
            }
        }

        function updateCaptions(data) {
            const { current_line, timestamp } = data;

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®
            if (timestamp <= lastTimestamp && current_line === lastLine) {
                return;
            }

            lastTimestamp = timestamp;

            // å¦‚æœå½“å‰è¡Œä¸ºç©ºï¼Œåªåœ¨ä¹‹å‰æœ‰å†…å®¹æ—¶æ‰æ¸…ç©ºæœªå®Œæˆå¥å­
            if (!current_line || !current_line.trim()) {
                if (currentIncomplete.trim()) {
                    console.log('æ¸…ç©ºæœªå®Œæˆå¥å­:', currentIncomplete);
                    currentIncomplete = '';
                    renderCaptions();
                    updateStats();
                }
                return;
            }

            const newLine = current_line.trim();

            // æ£€æµ‹å†…å®¹ç¨³å®šæ€§
            if (newLine !== lastStableContent) {
                contentChangeCount++;

                // ç§»é™¤æ•°æ®ä¸ç¨³å®šæ£€æµ‹ï¼Œå§‹ç»ˆå¤„ç†æ›´æ–°
                console.log('å¤„ç†æ–°æ•°æ®æ›´æ–°:', newLine);

                // æ£€æµ‹æ˜¯å¦æ˜¯å®Œå…¨ä¸åŒçš„å†…å®¹ï¼ˆå¯èƒ½æ˜¯é‡ç½®æˆ–æ–°å¼€å§‹ï¼‰
                const lengthCondition = lastLine && newLine.length < lastLine.length * 0.5;
                const contentCondition = lastLine && !lastLine.toLowerCase().includes(newLine.toLowerCase().substring(0, Math.min(20, newLine.length)));

                console.log('ğŸ” å†…å®¹é‡ç½®æ£€æµ‹:', {
                    lastLineLength: lastLine ? lastLine.length : 0,
                    newLineLength: newLine.length,
                    lengthThreshold: lastLine ? lastLine.length * 0.5 : 0,
                    lengthCondition: lengthCondition,
                    contentCondition: contentCondition,
                    checkString: newLine.toLowerCase().substring(0, Math.min(20, newLine.length))
                });

                if (lengthCondition && contentCondition) {
                    console.log('æ£€æµ‹åˆ°å†…å®¹é‡ç½®ï¼Œä»:', lastLine, 'åˆ°:', newLine);

                    // åœ¨é‡ç½®ä¹‹å‰ï¼Œå…ˆä¿å­˜å½“å‰æœªå®Œæˆçš„å¥å­ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    if (currentIncomplete.trim() && !isAlreadyCompleted(currentIncomplete)) {
                        console.log('ğŸ”„ å†…å®¹é‡ç½®å‰ä¿å­˜æœªå®Œæˆå¥å­:', currentIncomplete);
                        completedSentences.push(currentIncomplete);
                        updateWordCount(currentIncomplete);
                        console.log('  âœ… å¥å­å·²ä¿å­˜åˆ°å†å²è®°å½•');
                    }

                    // ç„¶åè®¾ç½®æ–°çš„æœªå®Œæˆå¥å­
                    currentIncomplete = newLine;
                } else {
                    // æ­£å¸¸å¤„ç†æ–°çš„lineæ•°æ®
                    processNewLine(newLine);
                }

                // æ›´æ–°ç¨³å®šå†…å®¹è®°å½•
                if (newLine.length > lastStableContent.length) {
                    lastStableContent = newLine;
                    contentChangeCount = 0; // é‡ç½®å˜åŒ–è®¡æ•°
                }
            } else {
                // å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œé‡ç½®å˜åŒ–è®¡æ•°
                contentChangeCount = 0;
            }

            lastLine = current_line;

            renderCaptions();
            updateStats();

            // å¦‚æœå¯ç”¨äº†é€—å·æ¢è¡Œæ¨¡å¼ï¼Œå¤„ç†é€—å·åˆ†å‰²
            if (commaMode) {
                processCommaMode();
            }
        }

        function processNewLine(line) {
            // å¥å­ç»“æŸæ ‡ç‚¹
            const sentenceEndings = '.ã€‚ï¼!ï¼Ÿ?';

            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¥å­ç»“æŸæ ‡ç‚¹
            if (sentenceEndings.split('').some(char => line.includes(char))) {
                // åˆ†å‰²å¥å­
                const sentences = [];
                let tempSentence = '';

                for (const char of line) {
                    tempSentence += char;
                    if (sentenceEndings.includes(char)) {
                        const sentence = tempSentence.trim();
                        if (sentence && !isAlreadyCompleted(sentence)) {
                            sentences.push(sentence);
                        }
                        tempSentence = '';
                    }
                }

                // æ·»åŠ å®Œæ•´å¥å­åˆ°å†å²è®°å½•
                sentences.forEach(sentence => {
                    if (sentence && !isAlreadyCompleted(sentence)) {
                        completedSentences.push(sentence);
                        // æ›´æ–°å•è¯æ€»æ•°
                        updateWordCount(sentence);
                    }
                });

                // å¤„ç†å‰©ä½™æœªå®Œæˆçš„æ–‡æœ¬
                currentIncomplete = tempSentence.trim();

            } else {
                // æ²¡æœ‰å¥å­ç»“æŸæ ‡ç‚¹ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦æ˜¯å†…å®¹é‡ç½®ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
                const isContentReset = currentIncomplete.trim() &&
                                     line.length < currentIncomplete.length * 0.5 &&
                                     !currentIncomplete.toLowerCase().includes(line.toLowerCase().substring(0, Math.min(20, line.length)));

                if (isContentReset) {
                    console.log('ğŸ”„ åœ¨processNewLineä¸­æ£€æµ‹åˆ°å†…å®¹é‡ç½®:');
                    console.log('  ä¹‹å‰å¥å­:', currentIncomplete);
                    console.log('  æ–°å¥å­:', line);
                    console.log('  è‡ªåŠ¨ä¿å­˜ä¹‹å‰çš„å¥å­');

                    // ä¿å­˜ä¹‹å‰çš„æœªå®Œæˆå¥å­
                    if (!isAlreadyCompleted(currentIncomplete)) {
                        completedSentences.push(currentIncomplete);
                        updateWordCount(currentIncomplete);
                        console.log('  âœ… å¥å­å·²ä¿å­˜åˆ°å†å²è®°å½•');
                    } else {
                        console.log('  âš ï¸ å¥å­å·²å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜');
                    }

                    // è®¾ç½®æ–°çš„æœªå®Œæˆå¥å­
                    currentIncomplete = line;
                } else if (currentIncomplete.trim() && !isSentenceContinuation(currentIncomplete, line)) {
                    // æ£€æµ‹åˆ°å¥å­çªç„¶åˆ‡æ¢ï¼Œä¿å­˜ä¹‹å‰çš„æœªå®Œæˆå¥å­
                    console.log('ğŸ”„ æ£€æµ‹åˆ°å¥å­çªç„¶åˆ‡æ¢:');
                    console.log('  ä¹‹å‰å¥å­:', currentIncomplete);
                    console.log('  æ–°å¥å­:', line);
                    console.log('  è‡ªåŠ¨ä¿å­˜ä¹‹å‰çš„å¥å­');

                    // å°†ä¹‹å‰çš„æœªå®Œæˆå¥å­ä¿å­˜ä¸ºå®Œæˆå¥å­ï¼ˆä¸æ·»åŠ å¥å·ï¼Œä¿æŒåŸæ ·ï¼‰
                    if (!isAlreadyCompleted(currentIncomplete)) {
                        completedSentences.push(currentIncomplete);
                        // æ›´æ–°å•è¯æ€»æ•°
                        updateWordCount(currentIncomplete);
                        console.log('  âœ… å¥å­å·²ä¿å­˜åˆ°å†å²è®°å½•');
                    } else {
                        console.log('  âš ï¸ å¥å­å·²å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜');
                    }

                    // è®¾ç½®æ–°çš„æœªå®Œæˆå¥å­
                    currentIncomplete = line;
                } else if (currentIncomplete.trim()) {
                    console.log('ğŸ“ å¥å­å»¶ç»­æ›´æ–°:', line);
                    // è®¾ç½®æ–°çš„æœªå®Œæˆå¥å­
                    currentIncomplete = line;
                } else {
                    // è®¾ç½®æ–°çš„æœªå®Œæˆå¥å­
                    currentIncomplete = line;
                }
            }
        }

        // æ£€æŸ¥æ–°å¥å­æ˜¯å¦æ˜¯å½“å‰æœªå®Œæˆå¥å­çš„å»¶ç»­
        function isSentenceContinuation(currentSentence, newSentence) {
            if (!currentSentence || !newSentence) {
                return false;
            }

            const current = currentSentence.trim().toLowerCase();
            const newText = newSentence.trim().toLowerCase();

            // å¦‚æœä¸¤ä¸ªå¥å­å®Œå…¨ç›¸åŒï¼Œè®¤ä¸ºæ˜¯å»¶ç»­
            if (current === newText) {
                return true;
            }

            // å¦‚æœæ–°å¥å­å®Œå…¨åŒ…å«å½“å‰å¥å­ï¼Œè®¤ä¸ºæ˜¯å»¶ç»­
            if (newText.includes(current)) {
                return true;
            }

            // å¦‚æœå½“å‰å¥å­åŒ…å«æ–°å¥å­ï¼Œå¯èƒ½æ˜¯å›é€€ä¿®æ­£ï¼Œä¹Ÿè®¤ä¸ºæ˜¯å»¶ç»­
            if (current.includes(newText)) {
                return true;
            }

            // æ£€æŸ¥å•è¯çº§åˆ«çš„é‡å 
            const currentWords = current.split(/\s+/).filter(w => w);
            const newWords = newText.split(/\s+/).filter(w => w);

            if (currentWords.length === 0 || newWords.length === 0) {
                return false;
            }

            // å¦‚æœå…¶ä¸­ä¸€ä¸ªå¥å­å¤ªçŸ­ï¼ˆå°‘äº3ä¸ªå•è¯ï¼‰ï¼Œä½¿ç”¨æ›´å®½æ¾çš„æ£€æµ‹
            if (currentWords.length < 3 || newWords.length < 3) {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å•è¯é‡å 
                const hasOverlap = currentWords.some(word => newWords.includes(word));
                console.log('ğŸ” çŸ­å¥å­é‡å æ£€æµ‹:', {
                    currentWords: currentWords,
                    newWords: newWords,
                    hasOverlap: hasOverlap
                });
                return hasOverlap;
            }

            // è®¡ç®—å‰å‡ ä¸ªå•è¯çš„åŒ¹é…åº¦
            const checkLength = Math.min(currentWords.length, newWords.length, 5); // æ£€æŸ¥å‰5ä¸ªå•è¯
            let matchCount = 0;

            for (let i = 0; i < checkLength; i++) {
                if (currentWords[i] === newWords[i]) {
                    matchCount++;
                }
            }

            // å¦‚æœå‰é¢çš„å•è¯æœ‰50%ä»¥ä¸ŠåŒ¹é…ï¼Œè®¤ä¸ºæ˜¯å»¶ç»­
            const matchRatio = matchCount / checkLength;
            if (matchRatio >= 0.5) {
                return true;
            }

            // æ£€æŸ¥æ˜¯å¦æ–°å¥å­ä»¥å½“å‰å¥å­çš„æœ€åå‡ ä¸ªå•è¯å¼€å§‹
            if (currentWords.length >= 2 && newWords.length >= 2) {
                const lastWords = currentWords.slice(-2); // å–æœ€å2ä¸ªå•è¯
                const firstWords = newWords.slice(0, 2); // å–å‰2ä¸ªå•è¯

                if (lastWords.some(word => firstWords.includes(word))) {
                    return true;
                }
            }

            // æœ€åæ£€æŸ¥ï¼šè®¡ç®—æ•´ä½“ç›¸ä¼¼åº¦ï¼Œå¦‚æœç›¸ä¼¼åº¦å¾ˆé«˜ï¼Œä¹Ÿè®¤ä¸ºæ˜¯å»¶ç»­
            const similarity = calculateSimilarity(current, newText);
            if (similarity > 0.3) { // 30%ä»¥ä¸Šç›¸ä¼¼åº¦è®¤ä¸ºæ˜¯å»¶ç»­
                return true;
            }

            return false;
        }

        // æ£€æŸ¥å¥å­æ˜¯å¦å·²ç»å®Œæˆï¼ˆæ›´ä¸¥æ ¼çš„é‡å¤æ£€æµ‹ï¼‰
        function isAlreadyCompleted(sentence) {
            const normalizedSentence = sentence.toLowerCase().trim();

            return completedSentences.some(completed => {
                const normalizedCompleted = completed.toLowerCase().trim();

                // å®Œå…¨ç›¸åŒ
                if (normalizedCompleted === normalizedSentence) {
                    return true;
                }

                // æ£€æŸ¥ç›¸ä¼¼åº¦ï¼ˆé˜²æ­¢è½»å¾®å˜åŒ–çš„é‡å¤ï¼‰
                const similarity = calculateSimilarity(normalizedCompleted, normalizedSentence);
                if (similarity > 0.85) { // 85%ä»¥ä¸Šç›¸ä¼¼åº¦è®¤ä¸ºæ˜¯é‡å¤
                    console.log('æ£€æµ‹åˆ°ç›¸ä¼¼å¥å­:', {
                        existing: completed,
                        new: sentence,
                        similarity: similarity
                    });
                    return true;
                }

                return false;
            });
        }

        // è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦
        function calculateSimilarity(str1, str2) {
            const words1 = str1.split(/\s+/);
            const words2 = str2.split(/\s+/);

            const maxLength = Math.max(words1.length, words2.length);
            if (maxLength === 0) return 1;

            let matchCount = 0;
            const minLength = Math.min(words1.length, words2.length);

            for (let i = 0; i < minLength; i++) {
                if (words1[i] === words2[i]) {
                    matchCount++;
                }
            }

            return matchCount / maxLength;
        }

        function renderCaptions() {
            let shouldScheduleScroll = false;

            // åªæ·»åŠ æ–°çš„å®Œæˆå¥å­ï¼Œä¸é‡æ–°æ¸²æŸ“å·²å­˜åœ¨çš„
            if (completedSentences.length > lastCompletedCount) {
                for (let i = lastCompletedCount; i < completedSentences.length; i++) {
                    const sentence = completedSentences[i];
                    if (sentence.trim()) {
                        const sentenceEl = createSentenceElementWithWords(sentence, true, `completed-${i}`);

                        // å¦‚æœæœ‰æœªå®Œæˆçš„å¥å­ï¼Œæ’å…¥åˆ°å®ƒä¹‹å‰
                        const incompleteEl = document.getElementById('current-incomplete');
                        if (incompleteEl) {
                            contentWrapper.insertBefore(sentenceEl, incompleteEl);
                        } else {
                            contentWrapper.appendChild(sentenceEl);
                        }
                    }
                }
                lastCompletedCount = completedSentences.length;
                shouldScheduleScroll = true;
            }

            // æ›´æ–°æˆ–åˆ›å»ºå½“å‰æœªå®Œæˆçš„å¥å­
            const hadIncomplete = document.getElementById('current-incomplete') !== null;
            updateIncompleteElement();
            const hasIncomplete = document.getElementById('current-incomplete') !== null;

            // å¦‚æœæ–°åˆ›å»ºäº†æœªå®Œæˆå¥å­ï¼Œä¹Ÿéœ€è¦è°ƒæ•´æ»šåŠ¨ä½ç½®
            if (!hadIncomplete && hasIncomplete) {
                shouldScheduleScroll = true;
            }

            // å®‰æ’æ»šåŠ¨è°ƒæ•´ï¼Œä¿æŒæ–°å¥å­åœ¨70%ä½ç½®
            if (shouldScheduleScroll && autoScrollEnabled) {
                scheduleAutoScroll();
            }
        }

        function updateIncompleteElement() {
            const existingIncomplete = document.getElementById('current-incomplete');

            if (currentIncomplete.trim()) {
                if (existingIncomplete) {
                    // ä½¿ç”¨æ™ºèƒ½å•è¯çº§æ›´æ–°
                    updateWordsInElement(existingIncomplete, currentIncomplete);
                } else {
                    // åˆ›å»ºæ–°çš„æœªå®Œæˆå¥å­å…ƒç´ 
                    const incompleteEl = createSentenceElementWithWords(currentIncomplete, false, 'current-incomplete');
                    contentWrapper.appendChild(incompleteEl);
                }
            } else {
                // å¦‚æœæ²¡æœ‰æœªå®Œæˆçš„å¥å­ï¼Œç§»é™¤ç°æœ‰çš„æœªå®Œæˆå…ƒç´ 
                if (existingIncomplete) {
                    existingIncomplete.remove();
                }
            }
        }

        // æ™ºèƒ½å•è¯çº§æ›´æ–°å‡½æ•°
        function updateWordsInElement(element, newText) {
            // æ·»åŠ å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿å…ƒç´ ä»ç„¶åœ¨DOMä¸­
            if (!element || !element.isConnected) {
                console.warn('å°è¯•æ›´æ–°å·²æ–­å¼€è¿æ¥çš„å…ƒç´ ï¼Œè·³è¿‡æ›´æ–°');
                return;
            }

            const textContainer = element.querySelector('.sentence-text');
            if (!textContainer || !textContainer.isConnected) {
                console.warn('æ–‡æœ¬å®¹å™¨ä¸å­˜åœ¨æˆ–å·²æ–­å¼€è¿æ¥ï¼Œè·³è¿‡æ›´æ–°');
                return;
            }

            const oldText = textContainer.getAttribute('data-text') || '';
            const oldWords = oldText.trim().split(/\s+/).filter(w => w);
            const newWords = newText.trim().split(/\s+/).filter(w => w);

            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸åŒçš„å•è¯ä½ç½®
            let firstDiffIndex = 0;
            while (firstDiffIndex < Math.min(oldWords.length, newWords.length) &&
                   oldWords[firstDiffIndex] === newWords[firstDiffIndex]) {
                firstDiffIndex++;
            }

            // å¦‚æœåªæ˜¯åœ¨æœ«å°¾æ·»åŠ å•è¯ï¼Œåªæ·»åŠ æ–°å•è¯
            if (firstDiffIndex === oldWords.length && newWords.length > oldWords.length) {
                // åªæ·»åŠ æ–°å•è¯
                for (let i = firstDiffIndex; i < newWords.length; i++) {
                    // å†æ¬¡æ£€æŸ¥å®¹å™¨æ˜¯å¦ä»ç„¶è¿æ¥
                    if (!textContainer.isConnected) {
                        console.warn('æ–‡æœ¬å®¹å™¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ–­å¼€è¿æ¥ï¼Œåœæ­¢æ›´æ–°');
                        return;
                    }

                    // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå•è¯ä¸”å®¹å™¨ä¸­å·²æœ‰å†…å®¹ï¼Œæ·»åŠ ç©ºæ ¼
                    if (i > 0 || textContainer.childNodes.length > 0) {
                        textContainer.appendChild(document.createTextNode(' '));
                    }
                    const wordSpan = createWordElement(newWords[i], false, false); // æœªå®Œæˆå¥å­ä¸­çš„å•è¯
                    textContainer.appendChild(wordSpan);
                }
            } else if (firstDiffIndex < newWords.length) {
                // æœ‰ä¿®æ”¹æˆ–åˆ é™¤ï¼Œéœ€è¦é‡æ–°æ¸²æŸ“ä»ä¿®æ”¹ä½ç½®å¼€å§‹çš„æ‰€æœ‰å•è¯

                // ç§»é™¤ä»ä¿®æ”¹ä½ç½®å¼€å§‹çš„æ‰€æœ‰å†…å®¹
                const childNodes = Array.from(textContainer.childNodes);
                let nodeIndex = 0;
                let wordCount = 0;

                // æ‰¾åˆ°å¯¹åº”ä¿®æ”¹ä½ç½®çš„DOMèŠ‚ç‚¹
                for (let i = 0; i < childNodes.length && wordCount < firstDiffIndex; i++) {
                    if (childNodes[i].nodeType === Node.ELEMENT_NODE &&
                        childNodes[i].classList && childNodes[i].classList.contains('word')) {
                        wordCount++;
                    }
                    nodeIndex = i + 1;
                }

                // å®‰å…¨åœ°ç§»é™¤ä»ä¿®æ”¹ä½ç½®å¼€å§‹çš„æ‰€æœ‰èŠ‚ç‚¹
                try {
                    while (textContainer.childNodes.length > nodeIndex && textContainer.isConnected) {
                        const lastChild = textContainer.lastChild;
                        if (lastChild && lastChild.parentNode === textContainer) {
                            textContainer.removeChild(lastChild);
                        } else {
                            break; // å¦‚æœæ— æ³•å®‰å…¨ç§»é™¤ï¼Œåœæ­¢æ“ä½œ
                        }
                    }
                } catch (error) {
                    console.warn('ç§»é™¤å­èŠ‚ç‚¹æ—¶å‡ºé”™:', error);
                    return;
                }

                // æ·»åŠ ä¿®æ”¹åçš„å•è¯
                for (let i = firstDiffIndex; i < newWords.length; i++) {
                    // å†æ¬¡æ£€æŸ¥å®¹å™¨æ˜¯å¦ä»ç„¶è¿æ¥
                    if (!textContainer.isConnected) {
                        console.warn('æ–‡æœ¬å®¹å™¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ–­å¼€è¿æ¥ï¼Œåœæ­¢æ›´æ–°');
                        return;
                    }

                    if (i > firstDiffIndex || (firstDiffIndex > 0 && textContainer.childNodes.length > 0)) {
                        textContainer.appendChild(document.createTextNode(' '));
                    }
                    const wordSpan = createWordElement(newWords[i], false, false); // æœªå®Œæˆå¥å­ä¸­çš„å•è¯
                    textContainer.appendChild(wordSpan);
                }
            }

            // æ›´æ–°å­˜å‚¨çš„æ–‡æœ¬
            if (textContainer.isConnected) {
                textContainer.setAttribute('data-text', newText);
            }

            // å¯åŠ¨å•è¯ç¨³å®šåŒ–å®šæ—¶å™¨
            startWordStabilizeTimer();
        }

        // å¯åŠ¨å•è¯ç¨³å®šåŒ–å®šæ—¶å™¨
        function startWordStabilizeTimer() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (wordStabilizeTimer) {
                clearTimeout(wordStabilizeTimer);
            }

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ2ç§’åå°†æ›´æ–°ä¸­çš„å•è¯æ ‡è®°ä¸ºç¨³å®š
            wordStabilizeTimer = setTimeout(() => {
                stabilizeWords();
            }, 2000);
        }

        // å°†æ›´æ–°ä¸­çš„å•è¯æ ‡è®°ä¸ºç¨³å®š
        function stabilizeWords() {
            const incompleteElement = document.getElementById('current-incomplete');
            if (incompleteElement) {
                const updatingWords = incompleteElement.querySelectorAll('.word.updating');
                updatingWords.forEach(word => {
                    word.classList.remove('updating');
                    word.classList.add('stable');
                });
            }
        }

        // åˆ›å»ºå•è¯å…ƒç´ 
        function createWordElement(word, isStable, isInCompletedSentence = false) {
            const span = document.createElement('span');
            span.className = `word ${isStable ? 'stable' : 'updating'}`;
            span.textContent = word;

            // åªå¯¹æœªå®Œæˆå¥å­ä¸­çš„å•è¯æ·»åŠ é˜²ç¿»è¯‘å±æ€§
            if (!isInCompletedSentence) {
                addNoTranslateAttributes(span);
            }

            return span;
        }

        // æ·»åŠ é˜²ç¿»è¯‘å±æ€§çš„è¾…åŠ©å‡½æ•°ï¼ˆåªç”¨äºå®æ—¶æ›´æ–°çš„å†…å®¹ï¼‰
        function addNoTranslateAttributes(element) {
            element.setAttribute('data-immersive-translate-ignore', 'true');
            element.setAttribute('translate', 'no');
            element.setAttribute('notranslate', 'true');
            element.setAttribute('data-no-translate', 'true');
        }

        // ç§»é™¤é˜²ç¿»è¯‘å±æ€§çš„è¾…åŠ©å‡½æ•°ï¼ˆå½“å¥å­å®Œæˆæ—¶ä½¿ç”¨ï¼‰
        function removeNoTranslateAttributes(element) {
            element.removeAttribute('data-immersive-translate-ignore');
            element.removeAttribute('translate');
            element.removeAttribute('notranslate');
            element.removeAttribute('data-no-translate');
        }

        // åˆ›å»ºå¸¦å•è¯åˆ†å‰²çš„å¥å­å…ƒç´ 
        function createSentenceElementWithWords(text, isCompleted, id) {
            const div = document.createElement('div');
            div.className = `sentence ${isCompleted ? 'completed' : 'incomplete'}`;
            div.id = id;

            // åªå¯¹æœªå®Œæˆçš„å¥å­æ·»åŠ é˜²ç¿»è¯‘å±æ€§
            if (!isCompleted) {
                addNoTranslateAttributes(div);
            }

            const textDiv = document.createElement('div');
            textDiv.className = 'sentence-text';
            textDiv.setAttribute('data-text', text);

            // åªå¯¹æœªå®Œæˆçš„å¥å­æ·»åŠ é˜²ç¿»è¯‘å±æ€§
            if (!isCompleted) {
                addNoTranslateAttributes(textDiv);
            }

            // å°†æ–‡æœ¬åˆ†å‰²ä¸ºå•è¯å¹¶åˆ›å»ºå¯¹åº”çš„å…ƒç´ 
            const words = text.trim().split(/\s+/).filter(w => w);
            words.forEach((word, index) => {
                if (index > 0) {
                    textDiv.appendChild(document.createTextNode(' '));
                }
                const wordSpan = createWordElement(word, isCompleted, isCompleted);
                textDiv.appendChild(wordSpan);
            });

            div.appendChild(textDiv);
            return div;
        }

        function createSentenceElement(text, isCompleted, id) {
            const div = document.createElement('div');
            div.className = `sentence ${isCompleted ? 'completed' : 'incomplete'}`;
            div.id = id;

            // åªå¯¹æœªå®Œæˆçš„å¥å­æ·»åŠ é˜²ç¿»è¯‘å±æ€§
            if (!isCompleted) {
                addNoTranslateAttributes(div);
            }

            const textDiv = document.createElement('div');
            textDiv.className = 'sentence-text';
            textDiv.textContent = text;

            // åªå¯¹æœªå®Œæˆçš„å¥å­æ·»åŠ é˜²ç¿»è¯‘å±æ€§
            if (!isCompleted) {
                addNoTranslateAttributes(textDiv);
            }

            div.appendChild(textDiv);
            return div;
        }

        // å®‰æ’è‡ªåŠ¨æ»šåŠ¨ï¼ˆä¿æŒæ–°å¥å­åœ¨70%ä½ç½®ï¼‰
        function scheduleAutoScroll() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (scrollTimer) {
                clearTimeout(scrollTimer);
            }

            // å»¶è¿Ÿæ»šåŠ¨ï¼Œç­‰å¾…æ–‡æœ¬ç¨å¾®ç¨³å®š
            scrollTimer = setTimeout(() => {
                if (autoScrollEnabled) {
                    smoothScrollToBottom();
                }
            }, 500); // 0.5ç§’åæ‰§è¡Œæ»šåŠ¨ï¼Œæ›´å¿«å“åº”
        }

        // æ»šåŠ¨è®©æ–°å¥å­ä½ç½®ä¿æŒåœ¨é¡µé¢70%ä½ç½®
        function smoothScrollToBottom() {
            // è·å–å½“å‰æ­£åœ¨æ›´æ–°çš„å¥å­å…ƒç´ ï¼ˆæœªå®Œæˆçš„å¥å­æˆ–æœ€æ–°å®Œæˆçš„å¥å­ï¼‰
            const incompleteEl = document.getElementById('current-incomplete');
            const targetElement = incompleteEl || contentWrapper.lastElementChild;

            if (!targetElement) return;

            // è®¡ç®—ç›®æ ‡ä½ç½®ï¼šé¡µé¢é«˜åº¦çš„70%
            const viewportHeight = window.innerHeight;
            const targetViewportPosition = viewportHeight * 0.5;

            // è·å–ç›®æ ‡å…ƒç´ å½“å‰åœ¨é¡µé¢ä¸­çš„ä½ç½®
            const elementRect = targetElement.getBoundingClientRect();
            const elementCurrentPosition = elementRect.top;

            // è®¡ç®—éœ€è¦æ»šåŠ¨çš„è·ç¦»ï¼Œè®©å…ƒç´ ç§»åŠ¨åˆ°70%ä½ç½®
            const scrollDistance = elementCurrentPosition - targetViewportPosition;

            // åªæœ‰å½“éœ€è¦æ»šåŠ¨è·ç¦»å¤§äº20pxæ—¶æ‰æ»šåŠ¨ï¼ˆé¿å…å¾®å°è°ƒæ•´ï¼‰
            if (Math.abs(scrollDistance) > 20) {
                const currentScroll = window.scrollY;
                const targetScroll = currentScroll + scrollDistance;

                window.scrollTo({
                    top: targetScroll,
                    behavior: 'smooth'
                });
            }
        }

        function clearCaptions() {
            contentWrapper.innerHTML = '<div class="sentence completed"><div class="sentence-text">å­—å¹•å·²æ¸…ç©ºï¼Œç­‰å¾…æ–°æ•°æ®...</div></div>';
            completedSentences = [];
            currentIncomplete = '';
            lastLine = '';  // é‡ç½®ä¸Šæ¬¡lineè®°å½•
            lastTimestamp = 0;  // é‡ç½®æ—¶é—´æˆ³
            lastCompletedCount = 0;  // é‡ç½®å®Œæˆå¥å­è®¡æ•°
            lastStableContent = '';  // é‡ç½®ç¨³å®šå†…å®¹è®°å½•
            contentChangeCount = 0;  // é‡ç½®å†…å®¹å˜åŒ–è®¡æ•°

            // é‡ç½®ç»Ÿè®¡æ•°æ®
            startTime = null;
            totalWords = 0;
            stopTimeUpdateInterval();

            // æ¸…é™¤å•è¯ç¨³å®šåŒ–å®šæ—¶å™¨
            if (wordStabilizeTimer) {
                clearTimeout(wordStabilizeTimer);
                wordStabilizeTimer = null;
            }

            // æ¸…é™¤æ»šåŠ¨å®šæ—¶å™¨
            if (scrollTimer) {
                clearTimeout(scrollTimer);
                scrollTimer = null;
            }

            // æ¸…é™¤é€—å·åˆ†å‰²ç›¸å…³æ•°æ®
            commaSplitSentences = [];
            if (window.commaSplitStabilizeTimer) {
                clearTimeout(window.commaSplitStabilizeTimer);
                window.commaSplitStabilizeTimer = null;
            }

            updateStats();
        }

        function scrollToBottom() {
            // ä½¿ç”¨æ–°çš„å¹³æ»‘æ»šåŠ¨æœºåˆ¶
            smoothScrollToBottom();
        }

        function scrollToTop() {
            // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function toggleAutoScroll() {
            autoScrollEnabled = !autoScrollEnabled;

            if (autoScrollEnabled) {
                autoScrollBtnEl.classList.add('active');
                autoScrollTextEl.textContent = 'ğŸ”„ è‡ªåŠ¨æ»šåŠ¨';
            } else {
                autoScrollBtnEl.classList.remove('active');
                autoScrollTextEl.textContent = 'â¸ï¸ æ‰‹åŠ¨æ»šåŠ¨';
            }

            // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('autoScrollEnabled', autoScrollEnabled);
        }

        function updateStats() {
            completedCountEl.textContent = completedSentences.length;
            lastUpdateEl.textContent = new Date().toLocaleTimeString();
            totalWordsEl.textContent = totalWords;
            updateListeningTime();
        }

        // æ›´æ–°å•è¯æ€»æ•°
        function updateWordCount(sentence) {
            if (sentence && sentence.trim()) {
                const words = sentence.trim().split(/\s+/).filter(w => w);
                totalWords += words.length;
            }
        }

        // å¼€å§‹æ—¶é—´æ›´æ–°å®šæ—¶å™¨
        function startTimeUpdateInterval() {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
            }
            timeUpdateInterval = setInterval(updateListeningTime, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        }

        // åœæ­¢æ—¶é—´æ›´æ–°å®šæ—¶å™¨
        function stopTimeUpdateInterval() {
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
                timeUpdateInterval = null;
            }
        }

        // æ›´æ–°ç›‘å¬æ—¶é—´æ˜¾ç¤º
        function updateListeningTime() {
            if (!startTime || !listeningTimeEl) {
                if (listeningTimeEl) {
                    listeningTimeEl.textContent = '00:00:00';
                }
                return;
            }

            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000); // ç§’æ•°

            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;

            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            listeningTimeEl.textContent = timeString;
        }

        // å¤åˆ¶Lunaè„šæœ¬åŠŸèƒ½
        async function copyLunaScript() {
            const lunaScriptContent = `
import json
import threading
import time
import socket

_current_line = ""  # å½“å‰è¡Œæ•°æ®
_server_socket = None  # æœåŠ¡å™¨socket
_server_thread = None  # æœåŠ¡å™¨çº¿ç¨‹
_server_running = False  # æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€

def handle_request(client_socket):
    """å¤„ç†å•ä¸ªHTTPè¯·æ±‚"""
    try:
        request = client_socket.recv(1024).decode('utf-8')

        if 'GET /captions' in request:
            # æ„é€ å“åº”æ•°æ®
            data = {
                'current_line': _current_line,
                'timestamp': time.time()
            }

            response_body = json.dumps(data, ensure_ascii=False)
            response = f"""HTTP/1.1 200 OK\\r
Content-Type: application/json; charset=utf-8\\r
Access-Control-Allow-Origin: *\\r
Content-Length: {len(response_body.encode('utf-8'))}\\r
\\r
{response_body}"""
        else:
            response = "HTTP/1.1 404 Not Found\\r\\n\\r\\n"

        client_socket.send(response.encode('utf-8'))
    except Exception as e:
        print(f"å¤„ç†è¯·æ±‚é”™è¯¯: {e}")
    finally:
        client_socket.close()

def server_loop():
    """æœåŠ¡å™¨ä¸»å¾ªç¯"""
    global _server_socket, _server_running

    while _server_running:
        try:
            client_socket, addr = _server_socket.accept()
            # åœ¨æ–°çº¿ç¨‹ä¸­å¤„ç†è¯·æ±‚
            client_thread = threading.Thread(target=handle_request, args=(client_socket,), daemon=True)
            client_thread.start()
        except Exception as e:
            if _server_running:  # åªåœ¨æœåŠ¡å™¨è¿è¡Œæ—¶æ‰“å°é”™è¯¯
                print(f"æ¥å—è¿æ¥é”™è¯¯: {e}")

def start_server():
    """å¯åŠ¨HTTPæœåŠ¡å™¨"""
    global _server_socket, _server_thread, _server_running

    if _server_socket is None:
        try:
            print("æ­£åœ¨å¯åŠ¨CaptionæœåŠ¡å™¨...")
            _server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            _server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            _server_socket.bind(('127.0.0.1', 8765))
            _server_socket.listen(5)
            _server_running = True

            _server_thread = threading.Thread(target=server_loop, daemon=True)
            _server_thread.start()
            print("Caption server started on http://127.0.0.1:8765")
        except Exception as e:
            print(f"Failed to start server: {e}")
            # å°è¯•å…¶ä»–ç«¯å£
            try:
                print("å°è¯•ç«¯å£8766...")
                _server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                _server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                _server_socket.bind(('127.0.0.1', 8766))
                _server_socket.listen(5)
                _server_running = True

                _server_thread = threading.Thread(target=server_loop, daemon=True)
                _server_thread.start()
                print("Caption server started on http://127.0.0.1:8766")
            except Exception as e2:
                print(f"ç«¯å£8766ä¹Ÿå¤±è´¥: {e2}")

def stop_server():
    """åœæ­¢HTTPæœåŠ¡å™¨"""
    global _server_socket, _server_thread, _server_running

    _server_running = False
    if _server_socket:
        _server_socket.close()
        _server_socket = None
        _server_thread = None

def POSTSOLVE(line):
    """
    Lunaè„šæœ¬æ¥å£å‡½æ•°
    - ä¸åšä»»ä½•ç¼“å­˜å¤„ç†
    - åªæ˜¯å°†å½“å‰lineæ•°æ®æä¾›ç»™ç½‘é¡µç«¯
    - Lunaæ­£å¸¸è¿”å›lineå†…å®¹
    """
    global _current_line

    print(f"POSTSOLVEè¢«è°ƒç”¨ï¼Œline: '{line}'")  # è°ƒè¯•ä¿¡æ¯

    # å¯åŠ¨æœåŠ¡å™¨ï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰
    start_server()

    # æ›´æ–°å½“å‰è¡Œæ•°æ®ä¾›ç½‘é¡µç«¯è·å–
    _current_line = line if line else ""
    print(f"æ›´æ–°_current_line: '{_current_line}'")  # è°ƒè¯•ä¿¡æ¯

    # Lunaç›´æ¥è¿”å›åŸå§‹å†…å®¹ï¼Œä¸åšä»»ä½•å¤„ç†
    return line if line else ""
`.trim();

            try {
                await navigator.clipboard.writeText(lunaScriptContent);

                // ä¸´æ—¶æ›´æ”¹æŒ‰é’®æ–‡æœ¬ä»¥æ˜¾ç¤ºæˆåŠŸ
                const copyBtn = document.getElementById('copy-luna-script');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = 'âœ… å·²å¤åˆ¶!';
                copyBtn.style.backgroundColor = '#28a745';

                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.backgroundColor = '#007acc';
                }, 2000);

            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶è„šæœ¬å†…å®¹');
            }
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            document.body.setAttribute('data-theme', newTheme);

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            if (newTheme === 'light') {
                themeToggleEl.innerHTML = 'ğŸŒ™ é»‘æš—æ¨¡å¼';
            } else {
                themeToggleEl.innerHTML = 'â˜€ï¸ æµ…è‰²æ¨¡å¼';
            }

            // ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('theme', newTheme);
        }

        // æ§ä»¶éšè—/æ˜¾ç¤ºåŠŸèƒ½
        function toggleControls() {
            controlsHidden = !controlsHidden;

            if (controlsHidden) {
                document.body.classList.add('controls-hidden');
                hideControlsToggleEl.innerHTML = 'ğŸ‘ï¸ æ˜¾ç¤ºæ§ä»¶';
            } else {
                document.body.classList.remove('controls-hidden');
                hideControlsToggleEl.innerHTML = 'ğŸ‘ï¸ éšè—æ§ä»¶';
            }

            // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('controlsHidden', controlsHidden);
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            // ä»æœ¬åœ°å­˜å‚¨è·å–ä¸»é¢˜è®¾ç½®ï¼Œé»˜è®¤ä¸ºé»‘æš—æ¨¡å¼
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            if (savedTheme === 'light') {
                themeToggleEl.innerHTML = 'ğŸŒ™ é»‘æš—æ¨¡å¼';
            } else {
                themeToggleEl.innerHTML = 'â˜€ï¸ æµ…è‰²æ¨¡å¼';
            }
        }

        // åˆå§‹åŒ–æ§ä»¶æ˜¾ç¤ºçŠ¶æ€
        function initControls() {
            // ä»æœ¬åœ°å­˜å‚¨è·å–æ§ä»¶æ˜¾ç¤ºè®¾ç½®
            const savedControlsHidden = localStorage.getItem('controlsHidden') === 'true';
            controlsHidden = savedControlsHidden;

            if (controlsHidden) {
                document.body.classList.add('controls-hidden');
                hideControlsToggleEl.innerHTML = 'ğŸ‘ï¸ æ˜¾ç¤ºæ§ä»¶';
            } else {
                document.body.classList.remove('controls-hidden');
                hideControlsToggleEl.innerHTML = 'ğŸ‘ï¸ éšè—æ§ä»¶';
            }

            // è®¾ç½®æ‚¬æµ®åŒºåŸŸçš„äº‹ä»¶ç›‘å¬
            setupHoverEvents();
        }

        // åˆå§‹åŒ–è‡ªåŠ¨æ»šåŠ¨è®¾ç½®
        function initAutoScroll() {
            // ä»æœ¬åœ°å­˜å‚¨è·å–è‡ªåŠ¨æ»šåŠ¨è®¾ç½®ï¼Œé»˜è®¤ä¸ºå¼€å¯
            const savedAutoScroll = localStorage.getItem('autoScrollEnabled');
            autoScrollEnabled = savedAutoScroll !== null ? savedAutoScroll === 'true' : true;

            if (autoScrollEnabled) {
                autoScrollBtnEl.classList.add('active');
                autoScrollTextEl.textContent = 'ğŸ”„ è‡ªåŠ¨æ»šåŠ¨';
            } else {
                autoScrollBtnEl.classList.remove('active');
                autoScrollTextEl.textContent = 'â¸ï¸ æ‰‹åŠ¨æ»šåŠ¨';
            }
        }

        // åˆå§‹åŒ–é€—å·æ¢è¡Œæ¨¡å¼è®¾ç½®
        function initCommaMode() {
            // ä»æœ¬åœ°å­˜å‚¨è·å–é€—å·æ¢è¡Œæ¨¡å¼è®¾ç½®ï¼Œé»˜è®¤ä¸ºå…³é—­
            const savedCommaMode = localStorage.getItem('commaMode');
            commaMode = savedCommaMode === 'true';

            if (commaMode) {
                commaModeBtnEl.classList.add('active');
                commaModeTextEl.textContent = 'ğŸ“ é€—å·æ¢è¡Œ';
            } else {
                commaModeBtnEl.classList.remove('active');
                commaModeTextEl.textContent = 'ğŸ“ é€—å·æ¢è¡Œ';
            }
        }

        // åˆ‡æ¢é€—å·æ¢è¡Œæ¨¡å¼
        function toggleCommaMode() {
            commaMode = !commaMode;

            if (commaMode) {
                commaModeBtnEl.classList.add('active');
                commaModeTextEl.textContent = 'ğŸ“ é€—å·æ¢è¡Œ';
            } else {
                commaModeBtnEl.classList.remove('active');
                commaModeTextEl.textContent = 'ğŸ“ é€—å·æ¢è¡Œ';
                // å…³é—­æ¨¡å¼æ—¶æ¸…é™¤é€—å·åˆ†å‰²æ˜¾ç¤º
                clearCommaSplitDisplay();
            }

            // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('commaMode', commaMode);
        }

        // è®¾ç½®æ‚¬æµ®äº‹ä»¶ - ç®€åŒ–ç‰ˆæœ¬ï¼Œä¸»è¦ä¾é CSS
        function setupHoverEvents() {
            // CSSå·²ç»å¤„ç†äº†ä¸»è¦çš„hoveré€»è¾‘ï¼Œè¿™é‡Œåªéœ€è¦å¤„ç†ä¸€äº›è¾¹ç¼˜æƒ…å†µ
            // ä¸éœ€è¦å¤æ‚çš„JavaScriptäº‹ä»¶ç›‘å¬
        }

        // é€—å·æ¢è¡Œæ¨¡å¼å¤„ç†å‡½æ•°
        function processCommaMode() {
            if (!currentIncomplete.trim()) {
                clearCommaSplitDisplay();
                return;
            }

            // ä½¿ç”¨é€—å·åˆ†å‰²å¥å­
            const segments = splitByComma(currentIncomplete);
            updateCommaSplitDisplay(segments);
        }

        // æŒ‰é€—å·åˆ†å‰²å¥å­
        function splitByComma(text) {
            if (!text || !text.trim()) {
                return [];
            }

            const segments = [];
            let currentSegment = '';

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                currentSegment += char;

                // æ£€æµ‹é€—å·ï¼ˆåŒ…æ‹¬ä¸­è‹±æ–‡é€—å·ï¼‰
                if (char === ',' || char === 'ï¼Œ') {
                    const trimmedSegment = currentSegment.trim();
                    if (trimmedSegment) {
                        segments.push(trimmedSegment);
                    }
                    currentSegment = '';
                }
            }

            // æ·»åŠ æœ€åä¸€ä¸ªç‰‡æ®µï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const finalSegment = currentSegment.trim();
            if (finalSegment) {
                segments.push(finalSegment);
            }

            return segments;
        }

        // æ›´æ–°é€—å·åˆ†å‰²æ˜¾ç¤º
        function updateCommaSplitDisplay(segments) {
            const incompleteEl = document.getElementById('current-incomplete');
            if (!incompleteEl) {
                return;
            }

            // æŸ¥æ‰¾æˆ–åˆ›å»ºé€—å·åˆ†å‰²å®¹å™¨
            let splitContainer = incompleteEl.querySelector('.comma-split-container');
            if (!splitContainer) {
                splitContainer = document.createElement('div');
                splitContainer.className = 'comma-split-container';
                incompleteEl.appendChild(splitContainer);
            }

            // æ¯”è¾ƒæ–°æ—§åˆ†å‰²ç»“æœï¼Œåªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
            const existingSegments = Array.from(splitContainer.children);

            // æ›´æ–°æˆ–åˆ›å»ºåˆ†å‰²å¥å­å…ƒç´ 
            segments.forEach((segment, index) => {
                let segmentEl = existingSegments[index];

                if (!segmentEl) {
                    // åˆ›å»ºæ–°çš„åˆ†å‰²å¥å­å…ƒç´ 
                    segmentEl = document.createElement('div');
                    segmentEl.className = 'comma-split-sentence updating';
                    addNoTranslateAttributes(segmentEl);
                    splitContainer.appendChild(segmentEl);
                } else if (segmentEl.textContent !== segment) {
                    // å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°æ ‡è®°ä¸ºæ›´æ–°ä¸­
                    segmentEl.className = 'comma-split-sentence updating';
                    addNoTranslateAttributes(segmentEl);
                }

                segmentEl.textContent = segment;
            });

            // ç§»é™¤å¤šä½™çš„åˆ†å‰²å¥å­å…ƒç´ 
            while (existingSegments.length > segments.length) {
                const extraEl = existingSegments.pop();
                if (extraEl && extraEl.parentNode) {
                    extraEl.parentNode.removeChild(extraEl);
                }
            }

            // å¯åŠ¨ç¨³å®šåŒ–å®šæ—¶å™¨
            startCommaSplitStabilizeTimer();
        }

        // æ¸…é™¤é€—å·åˆ†å‰²æ˜¾ç¤º
        function clearCommaSplitDisplay() {
            const incompleteEl = document.getElementById('current-incomplete');
            if (incompleteEl) {
                const splitContainer = incompleteEl.querySelector('.comma-split-container');
                if (splitContainer) {
                    splitContainer.remove();
                }
            }
            commaSplitSentences = [];
        }

        // å¯åŠ¨é€—å·åˆ†å‰²ç¨³å®šåŒ–å®šæ—¶å™¨
        function startCommaSplitStabilizeTimer() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (window.commaSplitStabilizeTimer) {
                clearTimeout(window.commaSplitStabilizeTimer);
            }

            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ2ç§’åå°†æ›´æ–°ä¸­çš„åˆ†å‰²å¥å­æ ‡è®°ä¸ºç¨³å®š
            window.commaSplitStabilizeTimer = setTimeout(() => {
                stabilizeCommaSplitSentences();
            }, 2000);
        }

        // å°†æ›´æ–°ä¸­çš„é€—å·åˆ†å‰²å¥å­æ ‡è®°ä¸ºç¨³å®š
        function stabilizeCommaSplitSentences() {
            const incompleteEl = document.getElementById('current-incomplete');
            if (incompleteEl) {
                const updatingSegments = incompleteEl.querySelectorAll('.comma-split-sentence.updating');
                updatingSegments.forEach(segment => {
                    segment.classList.remove('updating');
                    segment.classList.add('stable');
                    removeNoTranslateAttributes(segment);
                });
            }
        }

        // Telegraphç›¸å…³åŠŸèƒ½
        let telegraphAccessToken = null;

        // å°†æ–‡æœ¬è½¬æ¢ä¸ºTelegraph Nodeæ ¼å¼
        function textToTelegraphNodes(text) {
            if (!text || !text.trim()) {
                return [];
            }

            // ç®€å•çš„æ®µè½åˆ†å‰²ï¼Œæ¯ä¸ªå¥å­ä½œä¸ºä¸€ä¸ªæ®µè½
            const sentences = text.split(/[.ã€‚ï¼!ï¼Ÿ?]/).filter(s => s.trim());
            const nodes = [];

            sentences.forEach(sentence => {
                const trimmed = sentence.trim();
                if (trimmed) {
                    nodes.push({
                        tag: 'p',
                        children: [trimmed + '.']
                    });
                }
            });

            return nodes.length > 0 ? nodes : [{
                tag: 'p',
                children: [text]
            }];
        }

        // å°†åŒ…å«ç¿»è¯‘çš„å†…å®¹è½¬æ¢ä¸ºTelegraph Nodeæ ¼å¼
        function contentWithTranslationToTelegraphNodes(sentencePairs) {
            if (!sentencePairs || sentencePairs.length === 0) {
                return [];
            }

            const nodes = [];

            // éå†æ¯ä¸ªå¥å­å¯¹
            sentencePairs.forEach(pair => {
                const original = pair.original.trim();
                const translation = pair.translation.trim();

                if (original) {
                    // åŸæ–‡æ®µè½
                    nodes.push({
                        tag: 'p',
                        children: [original]
                    });

                    // ç¿»è¯‘æ®µè½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç´§è·Ÿåœ¨åŸæ–‡åé¢
                    if (translation) {
                        nodes.push({
                            tag: 'p',
                            children: [{
                                tag: 'em',
                                children: [translation]
                            }]
                        });
                    }

                    // æ·»åŠ åˆ†éš”ç©ºè¡Œï¼ˆåœ¨æ¯ç»„åŸæ–‡+ç¿»è¯‘åï¼‰
                    nodes.push({
                        tag: 'p',
                        children: ['']
                    });
                }
            });

            return nodes.length > 0 ? nodes : [{
                tag: 'p',
                children: ['No content available']
            }];
        }

        // æå–æ²‰æµ¸å¼ç¿»è¯‘çš„å†…å®¹
        function extractImmersiveTranslationContent() {
            const completedSentenceElements = document.querySelectorAll('.sentence.completed');
            const sentencePairs = [];

            completedSentenceElements.forEach(sentenceEl => {
                // æå–åŸæ–‡
                const sentenceTextEl = sentenceEl.querySelector('.sentence-text');
                let originalContent = '';
                let translationContent = '';

                if (sentenceTextEl) {
                    // è·å–åŸæ–‡å†…å®¹
                    originalContent = sentenceTextEl.getAttribute('data-text') || '';

                    // å¦‚æœæ²¡æœ‰data-textå±æ€§ï¼Œå°è¯•ä»æ–‡æœ¬å†…å®¹ä¸­æå–ï¼ˆæ’é™¤ç¿»è¯‘éƒ¨åˆ†ï¼‰
                    if (!originalContent) {
                        // å…‹éš†å…ƒç´ ä»¥é¿å…ä¿®æ”¹åŸDOM
                        const clonedEl = sentenceTextEl.cloneNode(true);
                        // ç§»é™¤ç¿»è¯‘ç›¸å…³çš„å…ƒç´ 
                        const translationElements = clonedEl.querySelectorAll('.immersive-translate-target-wrapper, .immersive-translate-target-inner, [data-immersive-translate-translation-element-mark]');
                        translationElements.forEach(el => el.remove());
                        originalContent = clonedEl.textContent.trim();
                    }

                    // æå–ç¿»è¯‘å†…å®¹
                    const translationEl = sentenceEl.querySelector('.immersive-translate-target-inner');
                    if (translationEl) {
                        translationContent = translationEl.textContent.trim();
                    }
                }

                // å¦‚æœæœ‰åŸæ–‡å†…å®¹ï¼Œæ·»åŠ åˆ°æ•°ç»„ä¸­
                if (originalContent && originalContent.trim()) {
                    sentencePairs.push({
                        original: originalContent.trim(),
                        translation: translationContent || ''
                    });
                }
            });

            // å¦‚æœæœ‰æœªå®Œæˆçš„å¥å­ï¼Œä¹ŸåŒ…å«è¿›æ¥
            if (currentIncomplete.trim()) {
                sentencePairs.push({
                    original: currentIncomplete.trim(),
                    translation: ''
                });
            }

            return sentencePairs;
        }

        // è·å–æˆ–åˆ›å»ºTelegraphè´¦æˆ·
        async function ensureTelegraphAccount() {
            if (telegraphAccessToken) {
                return telegraphAccessToken;
            }

            try {
                const response = await fetch('https://api.telegra.ph/createAccount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        short_name: 'LiveCaptions',
                        author_name: 'Live Captions User',
                        author_url: ''
                    })
                });

                const data = await response.json();
                if (data.ok) {
                    telegraphAccessToken = data.result.access_token;
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('telegraphAccessToken', telegraphAccessToken);
                    return telegraphAccessToken;
                } else {
                    throw new Error(data.error || 'åˆ›å»ºTelegraphè´¦æˆ·å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºTelegraphè´¦æˆ·å¤±è´¥:', error);
                throw error;
            }
        }

        // å‘é€åˆ°Telegraph
        async function sendToTelegraph() {
            const telegraphBtn = document.getElementById('telegraph-btn');
            const titleInput = document.querySelector('.editable-title');

            // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
            if (completedSentences.length === 0 && !currentIncomplete.trim()) {
                alert('æ²¡æœ‰å†…å®¹å¯ä»¥å‘é€åˆ°Telegraph');
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            telegraphBtn.disabled = true;
            telegraphBtn.textContent = 'å‘é€ä¸­...';

            try {
                // ç¡®ä¿æœ‰Telegraphè´¦æˆ·
                const accessToken = await ensureTelegraphAccount();

                // è·å–æ ‡é¢˜
                const title = titleInput.value.trim() || 'Live Captions';

                // å‡†å¤‡å†…å®¹
                let allText = '';
                if (completedSentences.length > 0) {
                    allText = completedSentences.join(' ');
                }
                if (currentIncomplete.trim()) {
                    allText += (allText ? ' ' : '') + currentIncomplete;
                }

                // è½¬æ¢ä¸ºTelegraph Nodeæ ¼å¼
                const content = textToTelegraphNodes(allText);

                // åˆ›å»ºTelegraphé¡µé¢
                const response = await fetch('https://api.telegra.ph/createPage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        access_token: accessToken,
                        title: title,
                        author_name: 'Live Captions',
                        content: JSON.stringify(content),
                        return_content: false
                    })
                });

                const data = await response.json();
                if (data.ok) {
                    const pageUrl = data.result.url;
                    // åœ¨æ–°çª—å£ä¸­æ‰“å¼€Telegraphé¡µé¢
                    window.open(pageUrl, '_blank');

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`æˆåŠŸå‘é€åˆ°Telegraphï¼\né¡µé¢é“¾æ¥ï¼š${pageUrl}`);
                } else {
                    throw new Error(data.error || 'åˆ›å»ºTelegraphé¡µé¢å¤±è´¥');
                }

            } catch (error) {
                console.error('å‘é€åˆ°Telegraphå¤±è´¥:', error);
                alert('å‘é€åˆ°Telegraphå¤±è´¥ï¼š' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                telegraphBtn.disabled = false;
                telegraphBtn.textContent = 'å‘é€åˆ°Telegraph';
            }
        }

        // å‘é€åŒ…å«ç¿»è¯‘çš„å†…å®¹åˆ°Telegraph
        async function sendToTelegraphWithTranslation() {
            const telegraphWithTranslationBtn = document.getElementById('telegraph-with-translation-btn');
            const titleInput = document.querySelector('.editable-title');

            // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
            if (completedSentences.length === 0 && !currentIncomplete.trim()) {
                alert('æ²¡æœ‰å†…å®¹å¯ä»¥å‘é€åˆ°Telegraph');
                return;
            }

            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            telegraphWithTranslationBtn.disabled = true;
            telegraphWithTranslationBtn.textContent = 'å‘é€ä¸­...';

            try {
                // ç¡®ä¿æœ‰Telegraphè´¦æˆ·
                const accessToken = await ensureTelegraphAccount();

                // è·å–æ ‡é¢˜
                const title = titleInput.value.trim() || 'Live Captions (åŒè¯­ç‰ˆ)';

                // æå–åŸæ–‡å’Œç¿»è¯‘å†…å®¹
                const sentencePairs = extractImmersiveTranslationContent();

                console.log('æå–çš„å¥å­å¯¹:', sentencePairs);

                // æ£€æŸ¥æ˜¯å¦æœ‰ç¿»è¯‘å†…å®¹
                const hasTranslations = sentencePairs.some(pair => pair.translation.trim());
                if (!hasTranslations) {
                    // å¦‚æœæ²¡æœ‰ç¿»è¯‘å†…å®¹ï¼Œæç¤ºç”¨æˆ·
                    const useOriginalOnly = confirm('æœªæ£€æµ‹åˆ°ç¿»è¯‘å†…å®¹ï¼Œæ˜¯å¦åªå‘é€åŸæ–‡ï¼Ÿ\n\næç¤ºï¼šè¯·ç¡®ä¿æ²‰æµ¸å¼ç¿»è¯‘æ’ä»¶å·²ç»ç¿»è¯‘äº†é¡µé¢å†…å®¹ã€‚');
                    if (!useOriginalOnly) {
                        telegraphWithTranslationBtn.disabled = false;
                        telegraphWithTranslationBtn.textContent = 'å‘é€åˆ°Telegraph(å«ç¿»è¯‘)';
                        return;
                    }
                }

                // è½¬æ¢ä¸ºTelegraph Nodeæ ¼å¼ï¼ˆåŒ…å«ç¿»è¯‘ï¼‰
                const content = contentWithTranslationToTelegraphNodes(sentencePairs);

                // åˆ›å»ºTelegraphé¡µé¢
                const response = await fetch('https://api.telegra.ph/createPage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        access_token: accessToken,
                        title: title,
                        author_name: 'Live Captions',
                        content: JSON.stringify(content),
                        return_content: false
                    })
                });

                const data = await response.json();
                if (data.ok) {
                    const pageUrl = data.result.url;
                    // åœ¨æ–°çª—å£ä¸­æ‰“å¼€Telegraphé¡µé¢
                    window.open(pageUrl, '_blank');

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const hasTranslation = hasTranslations ? 'ï¼ˆåŒ…å«ç¿»è¯‘ï¼‰' : 'ï¼ˆä»…åŸæ–‡ï¼‰';
                    alert(`æˆåŠŸå‘é€åˆ°Telegraph${hasTranslation}ï¼\né¡µé¢é“¾æ¥ï¼š${pageUrl}`);
                } else {
                    throw new Error(data.error || 'åˆ›å»ºTelegraphé¡µé¢å¤±è´¥');
                }

            } catch (error) {
                console.error('å‘é€åˆ°Telegraphå¤±è´¥:', error);
                alert('å‘é€åˆ°Telegraphå¤±è´¥ï¼š' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                telegraphWithTranslationBtn.disabled = false;
                telegraphWithTranslationBtn.textContent = 'å‘é€åˆ°Telegraph(å«ç¿»è¯‘)';
            }
        }

        // é˜²æ­¢æ²‰æµ¸ç¿»è¯‘çš„MutationObserverï¼ˆåªä¿æŠ¤æœªå®Œæˆçš„å¥å­ï¼‰
        function setupImmersiveTranslateProtection() {
            const captionsContainer = document.getElementById('captions-container');
            if (!captionsContainer) return;

            // åˆ›å»ºMutationObserveræ¥ç›‘å¬DOMå˜åŒ–
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ·»åŠ çš„èŠ‚ç‚¹
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // åªå¯¹æœªå®Œæˆå¥å­ä¸­çš„å…ƒç´ ç§»é™¤æ²‰æµ¸ç¿»è¯‘å±æ€§
                                const incompleteParent = node.closest('.sentence.incomplete');
                                if (incompleteParent) {
                                    removeImmersiveTranslateAttributes(node);
                                }
                            }
                        });
                    }

                    // æ£€æŸ¥å±æ€§å˜åŒ–
                    if (mutation.type === 'attributes') {
                        const target = mutation.target;
                        if (target.nodeType === Node.ELEMENT_NODE) {
                            // åªä¿æŠ¤æœªå®Œæˆå¥å­ä¸­çš„å…ƒç´ 
                            const incompleteParent = target.closest('.sentence.incomplete');
                            if (incompleteParent && mutation.attributeName &&
                                mutation.attributeName.includes('immersive-translate')) {
                                target.removeAttribute(mutation.attributeName);
                            }
                        }
                    }
                });
            });

            // å¼€å§‹è§‚å¯Ÿå­—å¹•å®¹å™¨
            observer.observe(captionsContainer, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['data-immersive-translate-walked', 'data-immersive-translate-paragraph']
            });
        }

        // ç§»é™¤æ²‰æµ¸ç¿»è¯‘å±æ€§çš„å‡½æ•°
        function removeImmersiveTranslateAttributes(element) {
            // ç§»é™¤æ²‰æµ¸ç¿»è¯‘å¯èƒ½æ·»åŠ çš„å±æ€§
            const immersiveAttrs = [
                'data-immersive-translate-walked',
                'data-immersive-translate-paragraph',
                'data-immersive-translate-translation-element-mark'
            ];

            immersiveAttrs.forEach(attr => {
                if (element.hasAttribute(attr)) {
                    element.removeAttribute(attr);
                }
            });

            // é€’å½’å¤„ç†å­å…ƒç´ 
            if (element.children) {
                Array.from(element.children).forEach(child => {
                    removeImmersiveTranslateAttributes(child);
                });
            }
        }

        // å…¨å±€é”™è¯¯å¤„ç†å™¨ï¼Œç”¨äºæ•è·æ‰©å±•è„šæœ¬é”™è¯¯
        window.addEventListener('error', (event) => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰©å±•è„šæœ¬é”™è¯¯ï¼ˆé€šå¸¸åŒ…å«ç‰¹å®šçš„æ–‡ä»¶åæˆ–é”™è¯¯ä¿¡æ¯ï¼‰
            if (event.filename && (
                event.filename.includes('a2_hightlight.js') ||
                event.filename.includes('chrome-extension://') ||
                event.filename.includes('moz-extension://')
            )) {
                console.warn('æ•è·åˆ°æ‰©å±•è„šæœ¬é”™è¯¯ï¼Œå·²å¿½ç•¥:', event.error);
                event.preventDefault(); // é˜»æ­¢é”™è¯¯å†’æ³¡
                return true;
            }

            // æ£€æŸ¥é”™è¯¯æ¶ˆæ¯æ˜¯å¦ä¸DOMæ“ä½œç›¸å…³
            if (event.error && event.error.message && (
                event.error.message.includes('closest') ||
                event.error.message.includes('Cannot read properties of null') ||
                event.error.message.includes('Cannot read properties of undefined')
            )) {
                console.warn('æ•è·åˆ°DOMæ“ä½œé”™è¯¯ï¼Œå¯èƒ½æ¥è‡ªæ‰©å±•è„šæœ¬:', event.error);
                event.preventDefault();
                return true;
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            initTheme();
            initControls();
            initAutoScroll();
            initCommaMode();

            // åˆå§‹åŒ–ç»Ÿè®¡æ˜¾ç¤º
            updateStats();
            updateListeningTime();

            // è®¾ç½®æ²‰æµ¸ç¿»è¯‘é˜²æŠ¤
            setupImmersiveTranslateProtection();

            // ä»æœ¬åœ°å­˜å‚¨æ¢å¤Telegraphè®¿é—®ä»¤ç‰Œ
            const savedToken = localStorage.getItem('telegraphAccessToken');
            if (savedToken) {
                telegraphAccessToken = savedToken;
            }

            setTimeout(startPolling, 1000);
        });

        // é¡µé¢å…³é—­æ—¶åœæ­¢è½®è¯¢
        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>
</html>
